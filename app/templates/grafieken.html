{% extends "base.html" %}
{% block body_class %}page-grafieken{% endblock %}
{% block content %}

<!-- HERO -->
<section class="hero hero-grafieken">
  <h1 class="hero-title">Evolutie van Schriftelijke Vragen</h1>
  <p class="hero-subtitle">
    Bekijk de evolutie per <strong>thema</strong> of per <strong>volksvertegenwoordiger</strong> over de laatste maanden.<br>
    <em>Klik op een bolletje in de grafiek om de schriftelijke vragen van die maand te bekijken (en pdf te downloaden).</em>
  </p>
</section>

<!-- KEUZE & GRAFIEKEN -->
<section class="grafieken-section">

  <!-- Tabs -->
  <div style="margin-bottom:2rem;">
    <button id="tabThema"
            style="padding:0.5rem 1rem; border:none; border-radius:6px 0 0 6px; background:#2563eb; color:white; cursor:pointer;">
      Per Thema
    </button>
    <button id="tabVV"
            style="padding:0.5rem 1rem; border:none; border-radius:0 6px 6px 0; background:#e5e7eb; cursor:pointer;">
      Per Volksvertegenwoordiger
    </button>
  </div>

  <!-- PER THEMA -->
  <div id="themaDiv">
    <label for="themaSelect" style="font-weight:600; margin-right:10px;">Kies een thema:</label>
    <select id="themaSelect" style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:6px;">
      <option value="">-- Selecteer een thema --</option>
      {% for t in themas %}
        <option value="{{ t.id }}">{{ t.naam }}</option>
      {% endfor %}
    </select>

    <button id="toonGrafiek"
            style="margin-left:1rem; padding:0.5rem 1rem; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">
      Toon grafiek
    </button>

    <div style="max-width:800px; margin:2rem auto;">
      <canvas id="evolutieChart"></canvas>
    </div>
  </div>

  <!-- PER VOLKSVERTEGENWOORDIGER -->
  <div id="vvDiv" class="vv-container" style="display:none;">
    <div class="vv-row">
      <label for="vvInput" class="vv-label">Zoek volksvertegenwoordiger:</label>
      <input type="text" id="vvInput" placeholder="Typ een naam..." class="vv-input" autocomplete="off">
      <button id="toonVV" class="vv-button">Toon grafiek</button>
    </div>

    <div id="vvSuggesties" class="vv-suggesties"></div>

    <div class="chart-container">
      <canvas id="vvChart"></canvas>
    </div>
  </div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chart, vvChart;
let gekozenVV = null;
let gekozenThema = null;

/*ROBUUSTE MAAND-MAPPING (NL + EN + VARIANTEN)*/
const monthMap = {
  // NL afkortingen
  "jan": 1, "feb": 2, "mrt": 3, "apr": 4,
  "mei": 5, "jun": 6, "jul": 7, "aug": 8,
  "sep": 9, "okt": 10, "nov": 11, "dec": 12,

  // NL met punt
  "jan.": 1, "feb.": 2, "mrt.": 3, "apr.": 4,
  "mei.": 5, "jun.": 6, "jul.": 7, "aug.": 8,
  "sep.": 9, "okt.": 10, "nov.": 11, "dec.": 12,

  // EN afkortingen
  "jan": 1, "feb": 2, "mar": 3, "apr": 4,
  "may": 5, "jun": 6, "jul": 7, "aug": 8,
  "sep": 9, "oct": 10, "nov": 11, "dec": 12,

  // EN met punt
  "jan.": 1, "feb.": 2, "mar.": 3, "apr.": 4,
  "may.": 5, "jun.": 6, "jul.": 7, "aug.": 8,
  "sep.": 9, "oct.": 10, "nov.": 11, "dec.": 12,

  // Full English names
  "january": 1, "february": 2, "march": 3, "april": 4,
  "may": 5, "june": 6, "july": 7, "august": 8,
  "september": 9, "october": 10, "november": 11, "december": 12
};

/*TAB-SWITCHING*/
const tabThema = document.getElementById("tabThema");
const tabVV = document.getElementById("tabVV");
const themaDiv = document.getElementById("themaDiv");
const vvDiv = document.getElementById("vvDiv");

tabThema.addEventListener("click", () => {
  tabThema.style.background = "#2563eb";
  tabThema.style.color = "white";
  tabVV.style.background = "#e5e7eb";
  tabVV.style.color = "black";
  themaDiv.style.display = "block";
  vvDiv.style.display = "none";
});

tabVV.addEventListener("click", () => {
  tabVV.style.background = "#2563eb";
  tabVV.style.color = "white";
  tabThema.style.background = "#e5e7eb";
  tabThema.style.color = "black";
  vvDiv.style.display = "block";
  themaDiv.style.display = "none";
});

/*GRAFIEK PER THEMA*/
document.getElementById("toonGrafiek").addEventListener("click", async () => {
  const themaId = document.getElementById("themaSelect").value;
  if (!themaId) return alert("Selecteer eerst een thema.");
  gekozenThema = themaId;

  const response = await fetch(`/grafieken/data/${themaId}`);
  const data = await response.json();

  const ctx = document.getElementById("evolutieChart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Aantal vragen per maand',
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.2)',
        pointBackgroundColor: '#1e40af',
        pointBorderWidth: 3,
        pointRadius: 6,
        pointHoverRadius: 8,
        tension: 0.3,
        fill: true
      }]
    },
    options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: true, position: 'bottom' } } }
  });
});

/*KLIK OP PUNT IN GRAFIEK (THEMA)*/
document.getElementById("evolutieChart").onclick = async (evt) => {
  if (!chart || !gekozenThema) return;

  const points = chart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
  if (!points.length) return;

  const point = points[0];
  const label = chart.data.labels[point.index];
  const [maandStr, jaarStr] = label.split(" ");

  const maand = monthMap[maandStr.toLowerCase()];
  const jaar = parseInt(jaarStr);

  const resp = await fetch(`/grafieken/thema_vragen/${gekozenThema}/${jaar}/${maand}`);
  const vragen = await resp.json();

  if (!vragen.length) return alert(`Geen schriftelijke vragen in ${label}.`);

  let html = `<h3>Vragen van ${label}</h3><ul>`;
  vragen.forEach(v => {
    html += `<li><b>${v.datum}</b> — ${v.onderwerp}${
      v.link ? ` — <a href="${v.link}" target="_blank" style="color:#2563eb;">[pdf]</a>` : ""
    }</li>`;
  });
  html += "</ul>";

  const win = window.open("", "_blank", "width=600,height=600,scrollbars=yes");
  win.document.write(`<html><body style='font-family:sans-serif;'>${html}</body></html>`);
};

/*AUTOCOMPLETE VV*/
const input = document.getElementById('vvInput');
const suggestiesDiv = document.getElementById('vvSuggesties');

input.addEventListener('input', async () => {
  const q = input.value.trim();
  if (q.length < 2) { suggestiesDiv.innerHTML = ''; gekozenVV = null; return; }

  const resp = await fetch(`/grafieken/vv_suggesties?q=${encodeURIComponent(q)}`);
  const data = await resp.json();

  suggestiesDiv.innerHTML = data.map(v =>
    `<div class="suggestie" data-id="${v.id}" style="padding:5px; cursor:pointer; border-bottom:1px solid #ddd;">${v.naam}</div>`
  ).join('');
});

suggestiesDiv.addEventListener('click', e => {
  if (!e.target.dataset.id) return;
  gekozenVV = e.target.dataset.id;
  input.value = e.target.innerText;
  suggestiesDiv.innerHTML = '';
});

/*GRAFIEK PER VV*/
document.getElementById("toonVV").addEventListener("click", async () => {
  if (!gekozenVV) return alert("Selecteer eerst een volksvertegenwoordiger.");
  window.selectedVV = gekozenVV;

  const resp = await fetch(`/grafieken/vv_data/${gekozenVV}`);
  const data = await resp.json();

  const ctx = document.getElementById("vvChart").getContext("2d");
  if (vvChart) vvChart.destroy();

  vvChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Aantal vragen per maand',
        data: data.values,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239,68,68,0.2)',
        pointBackgroundColor: '#991b1b',
        pointBorderWidth: 3,
        pointRadius: 6,
        pointHoverRadius: 8,
        tension: 0.3,
        fill: true
      }]
    },
    options: { scales: { y: { beginAtZero: true } }, plugins: { legend: { display: true, position: 'bottom' } } }
  });
});

/* KLIK OP PUNT IN VV-GRAFIEK */
document.getElementById("vvChart").onclick = async (evt) => {
  if (!vvChart || !window.selectedVV) return;

  const points = vvChart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
  if (!points.length) return;

  const point = points[0];
  const label = vvChart.data.labels[point.index];
  const [maandStr, jaarStr] = label.split(" ");

  const maand = monthMap[maandStr.toLowerCase()];
  const jaar = parseInt(jaarStr);

  const resp = await fetch(`/grafieken/vv_vragen/${window.selectedVV}/${jaar}/${maand}`);
  const vragen = await resp.json();

  if (!vragen.length) return alert(`Geen schriftelijke vragen in ${label}.`);

  let html = `<h3>Vragen van ${label}</h3><ul>`;
  vragen.forEach(v => {
    html += `<li><b>${v.datum}</b> — ${v.onderwerp}${
      v.link ? ` — <a href="${v.link}" target="_blank" style="color:#2563eb;">[pdf]</a>` : ""
    }</li>`;
  });
  html += "</ul>";

  const win = window.open("", "_blank", "width=600,height=600,scrollbars=yes");
  win.document.write(`<html><body style='font-family:sans-serif;'>${html}</body></html>`);
};
</script>

{% endblock %}
