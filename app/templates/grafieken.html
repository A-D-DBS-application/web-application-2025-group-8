{% extends "base.html" %}
{% block content %}

<!-- HERO -->
<section class="hero" style="background:#facc15; color:#111;">
  <h1 class="hero-title">Evolutie van Schriftelijke Vragen</h1>
  <p class="hero-subtitle">
    Bekijk de evolutie per <strong>thema</strong> of per <strong>volksvertegenwoordiger</strong> over de laatste 12 maanden.<br>
    <span style="font-size:0.95em; color:#444;">
      ðŸ’¡ Klik op de <strong>bolletjes</strong> in de grafiek om de vragen van die maand te bekijken.
    </span>
  </p>
</section>

<!-- KEUZE & GRAFIEKEN -->
<section style="padding:2rem; text-align:center;">

  <!-- Tabs -->
  <div style="margin-bottom:2rem;">
    <button id="tabThema" 
            style="padding:0.5rem 1rem; border:none; border-radius:6px 0 0 6px; background:#2563eb; color:white; cursor:pointer;">
      Per Thema
    </button>
    <button id="tabVV"
            style="padding:0.5rem 1rem; border:none; border-radius:0 6px 6px 0; background:#e5e7eb; cursor:pointer;">
      Per Volksvertegenwoordiger
    </button>
  </div>

  <!-- PER THEMA -->
  <div id="themaDiv">
    <label for="themaSelect" style="font-weight:600; margin-right:10px;">Kies een thema:</label>
    <select id="themaSelect" style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:6px;">
      <option value="">-- Selecteer een thema --</option>
      {% for t in themas %}
        <option value="{{ t.id }}">{{ t.naam }}</option>
      {% endfor %}
    </select>

    <button id="toonGrafiek" 
            style="margin-left:1rem; padding:0.5rem 1rem; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">
      Toon grafiek
    </button>

    <div style="max-width:800px; margin:2rem auto;">
      <canvas id="evolutieChart"></canvas>
    </div>
  </div>

  <!-- PER VOLKSVERTEGENWOORDIGER -->
  <div id="vvDiv" style="display:none;">
    <label style="font-weight:600; margin-right:10px;">Zoek volksvertegenwoordiger:</label>
    <input type="text" id="vvInput" placeholder="Typ een naam..." 
           style="padding:0.5rem 1rem; border:1px solid #ccc; border-radius:6px; width:250px;" autocomplete="off">
    <div id="vvSuggesties" class="suggesties" 
         style="position:relative; max-width:260px; margin:0 auto; background:white; border-radius:4px; text-align:left;"></div>

    <button id="toonVV" 
            style="margin-left:1rem; padding:0.5rem 1rem; background:#2563eb; color:white; border:none; border-radius:6px; cursor:pointer;">
      Toon grafiek
    </button>

    <div style="max-width:800px; margin:2rem auto;">
      <canvas id="vvChart"></canvas>
    </div>
  </div>

</section>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chart;
let vvChart;
let selectedVV = null;

// Tabs
const tabThema = document.getElementById("tabThema");
const tabVV = document.getElementById("tabVV");
const themaDiv = document.getElementById("themaDiv");
const vvDiv = document.getElementById("vvDiv");

tabThema.addEventListener("click", () => {
  tabThema.style.background = "#2563eb";
  tabThema.style.color = "white";
  tabVV.style.background = "#e5e7eb";
  tabVV.style.color = "black";
  themaDiv.style.display = "block";
  vvDiv.style.display = "none";
});

tabVV.addEventListener("click", () => {
  tabVV.style.background = "#2563eb";
  tabVV.style.color = "white";
  tabThema.style.background = "#e5e7eb";
  tabThema.style.color = "black";
  vvDiv.style.display = "block";
  themaDiv.style.display = "none";
});

// --- GRAFIEK PER THEMA ---
document.getElementById("toonGrafiek").addEventListener("click", async () => {
  const themaId = document.getElementById("themaSelect").value;
  if (!themaId) return alert("Selecteer eerst een thema.");

  const response = await fetch(`/grafieken/data/${themaId}`);
  const data = await response.json();

  const ctx = document.getElementById("evolutieChart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Aantal vragen per maand',
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.2)',
        tension: 0.3,
        fill: true,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 9,
        pointHoverBackgroundColor: '#1d4ed8'
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: true, position: 'bottom' } }
    }
  });

  // Klik op een datapunt in THEMA-grafiek
  document.getElementById("evolutieChart").onclick = async (evt) => {
    if (!chart) return;

    const points = chart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
    if (!points.length) return;

    const point = points[0];
    const label = chart.data.labels[point.index]; // bv. "May 2025"
    const [maandStr, jaarStr] = label.split(" ");
    const maand = new Date(Date.parse(maandStr + " 1, 2024")).getMonth() + 1;
    const jaar = parseInt(jaarStr);

    const themaId = document.getElementById("themaSelect").value;
    if (!themaId) return;

    const response = await fetch(`/grafieken/thema_vragen/${themaId}/${jaar}/${maand}`);
    const data = await response.json();

    if (!data.length) return alert("Geen schriftelijke vragen in " + label);

    let html = `<h3>Vragen van ${label}</h3><ul>`;
    data.forEach(v => {
      html += `<li><b>${v.datum}</b> â€” ${v.onderwerp}</li>`;
    });
    html += "</ul>";

    const win = window.open("", "_blank", "width=600,height=600,scrollbars=yes");
    win.document.write(`<html><body style='font-family:sans-serif;'>${html}</body></html>`);
  };
});

// --- AUTOCOMPLETE VV ---
const input = document.getElementById('vvInput');
const suggestiesDiv = document.getElementById('vvSuggesties');

input.addEventListener('input', async () => {
  const q = input.value.trim();
  if (q.length < 2) { suggestiesDiv.innerHTML = ''; selectedVV = null; return; }

  const resp = await fetch(`/grafieken/vv_suggesties?q=${encodeURIComponent(q)}`);
  const data = await resp.json();

  suggestiesDiv.innerHTML = data.map(v =>
    `<div class="suggestie" data-id="${v.id}" style="padding:5px; cursor:pointer; border-bottom:1px solid #ddd;">${v.naam}</div>`
  ).join('');
});

suggestiesDiv.addEventListener('click', e => {
  if (!e.target.dataset.id) return;
  selectedVV = e.target.dataset.id;
  input.value = e.target.innerText;
  suggestiesDiv.innerHTML = '';
});

// --- GRAFIEK PER VV ---
document.getElementById("toonVV").addEventListener("click", async () => {
  if (!selectedVV) return alert("Selecteer eerst een volksvertegenwoordiger.");

  const resp = await fetch(`/grafieken/vv_data/${selectedVV}`);
  const data = await resp.json();

  const ctx = document.getElementById("vvChart").getContext("2d");
  if (vvChart) vvChart.destroy();

  vvChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: 'Aantal vragen per maand',
        data: data.values,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239,68,68,0.2)',
        tension: 0.3,
        fill: true,
        pointBackgroundColor: '#ef4444',
        pointBorderColor: '#ffffff',
        pointBorderWidth: 2,
        pointRadius: 6,
        pointHoverRadius: 9,
        pointHoverBackgroundColor: '#dc2626'
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: true, position: 'bottom' } }
    }
  });

  window.selectedVV = selectedVV; // nodig voor klik op maand
});

// --- Klik op een datapunt in VV-grafiek ---
document.getElementById("vvChart").onclick = async (evt) => {
  if (!vvChart) return;

  const points = vvChart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
  if (!points.length) return;

  const point = points[0];
  const label = vvChart.data.labels[point.index]; // bv. "May 2025"
  const [maandStr, jaarStr] = label.split(" ");
  const maand = new Date(Date.parse(maandStr + " 1, 2024")).getMonth() + 1;
  const jaar = parseInt(jaarStr);

  const vvId = window.selectedVV;
  if (!vvId) return;

  const response = await fetch(`/grafieken/vv_vragen/${vvId}/${jaar}/${maand}`);
  const data = await response.json();

  if (!data.length) return alert("Geen schriftelijke vragen in " + label);

  let html = `<h3>Vragen van ${label}</h3><ul>`;
  data.forEach(v => {
    html += `<li><b>${v.datum}</b> â€” ${v.onderwerp}</li>`;
  });
  html += "</ul>";

  const win = window.open("", "_blank", "width=600,height=600,scrollbars=yes");
  win.document.write(`<html><body style='font-family:sans-serif;'>${html}</body></html>`);
};
</script>

{% endblock %}
