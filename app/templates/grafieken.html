{% extends "base.html" %}

{% block content %}

<!-- HERO -->
<section class="hero">
  <h1 class="hero-title">Evolutie van Schriftelijke Vragen</h1>
  <p class="hero-subtitle">
    Bekijk de evolutie per <strong>thema</strong> of per <strong>volksvertegenwoordiger</strong> over de laatste maanden.<br>
    <em>Klik op een bolletje in de grafiek om de details te zien.</em>
  </p>
</section>

<!-- KEUZE & GRAFIEKEN -->
<section class="p-4">
  <div class="container" style="max-width: 1000px;">

    <!-- Tabs (Gebruikt nu jouw style.css classes) -->
    <div class="tabs-container text-center">
      <button id="tabThema" class="tab-btn left active">
        Per Thema
      </button>
      <button id="tabVV" class="tab-btn right inactive">
        Per Volksvertegenwoordiger
      </button>
    </div>

    <!-- PER THEMA -->
    <div id="themaDiv" class="card p-4">
      <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
        <label for="themaSelect" class="fw-bold m-0">Kies een thema:</label>

        <select id="themaSelect" class="form-select" style="max-width:320px;">
          <option value="">-- Selecteer een thema --</option>
          {% for t in themas %}
            <option value="{{ t.id }}">{{ t.naam }}</option>
          {% endfor %}
        </select>

        <button id="toonGrafiek" class="btn btn-primary">
          Toon grafiek
        </button>
      </div>

      <div class="mt-4" style="position: relative; height:400px; width:100%">
        <canvas id="evolutieChart"></canvas>
      </div>
    </div>

    <!-- PER VOLKSVERTEGENWOORDIGER -->
    <div id="vvDiv" class="card p-4" style="display:none;">
      <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
        <label class="fw-bold m-0">Zoek volksvertegenwoordiger:</label>

        <div style="position:relative; width:300px;">
          <input type="text" id="vvInput" placeholder="Typ een naam..." 
                 class="form-control" autocomplete="off">
          
          <div id="vvSuggesties" class="list-group position-absolute w-100" 
               style="z-index:1000; max-height:200px; overflow-y:auto; display:none;"></div>
        </div>

        <button id="toonVV" class="btn btn-primary">
          Toon grafiek
        </button>
      </div>

      <div class="mt-4" style="position: relative; height:400px; width:100%">
        <canvas id="vvChart"></canvas>
      </div>
    </div>

  </div>
</section>

<!-- MODAL VOOR DETAILS (Mooier dan een pop-up venster) -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="modalTitle">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalContent" class="list-group list-group-flush">
          <!-- Hier komen de vragen -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sluiten</button>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chart, vvChart;
let gekozenVV = null;
let gekozenThema = null;

// Tabs
const tabThema = document.getElementById("tabThema");
const tabVV = document.getElementById("tabVV");
const themaDiv = document.getElementById("themaDiv");
const vvDiv = document.getElementById("vvDiv");

tabThema.addEventListener("click", () => {
  tabThema.className = "tab-btn left active";
  tabVV.className = "tab-btn right inactive";
  themaDiv.style.display = "block";
  vvDiv.style.display = "none";
});

tabVV.addEventListener("click", () => {
  tabVV.className = "tab-btn left inactive";
  tabThema.className = "tab-btn right active";
  vvDiv.style.display = "block";
  themaDiv.style.display = "none";
});


// === GRAFIEK PER THEMA ===
document.getElementById("toonGrafiek").addEventListener("click", async () => {
  const themaSelect = document.getElementById("themaSelect");
  const themaId = themaSelect.value;
  const themaNaam = themaSelect.options[themaSelect.selectedIndex].text;

  if (!themaId) return alert("Selecteer eerst een thema.");
  gekozenThema = themaId;

  const response = await fetch(`/grafieken/data/${themaId}`);
  if (!response.ok) return alert("Kon geen data ophalen voor dit thema.");
  const data = await response.json();

  const ctx = document.getElementById("evolutieChart").getContext("2d");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: `Aantal vragen: ${themaNaam}`,
        data: data.values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.2)',
        pointBackgroundColor: '#1e40af',
        pointBorderWidth: 3,
        pointRadius: 6,
        pointHoverRadius: 8,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: true, position: 'bottom' } }
    }
  });
});


// === KLIK OP PUNT IN GRAFIEK PER THEMA (Met jouw Fix!) ===
document.getElementById("evolutieChart").onclick = async (evt) => {
  if (!chart || !gekozenThema) return;
  const points = chart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
  if (!points.length) return;

  const point = points[0];
  const label = chart.data.labels[point.index];
  const [maandStr, jaarStr] = label.split(" ");
  
  const nlMaanden = {
    "jan":1, "feb":2, "mrt":3, "apr":4, "mei":5, "jun":6,
    "jul":7, "aug":8, "sep":9, "okt":10, "nov":11, "dec":12
  };

  const maand = nlMaanden[maandStr.toLowerCase()];
  const jaar = parseInt(jaarStr);

  const response = await fetch(`/grafieken/thema_vragen/${gekozenThema}/${jaar}/${maand}`);
  const data = await response.json();

  toonDetails(data, `${maandStr} ${jaar}`);
};


// === AUTOCOMPLETE VOOR VV ===
const input = document.getElementById('vvInput');
const suggestiesDiv = document.getElementById('vvSuggesties');

input.addEventListener('input', async () => {
  const q = input.value.trim();
  if (q.length < 2) { 
      suggestiesDiv.innerHTML = ''; 
      suggestiesDiv.style.display = 'none';
      gekozenVV = null; 
      return; 
  }

  const resp = await fetch(`/grafieken/vv_suggesties?q=${encodeURIComponent(q)}`);
  const data = await resp.json();

  suggestiesDiv.innerHTML = '';
  if (data.length > 0) {
      suggestiesDiv.style.display = 'block';
      data.forEach(v => {
        const div = document.createElement('button');
        div.className = "list-group-item list-group-item-action text-start";
        div.textContent = v.naam;
        div.onclick = () => {
            gekozenVV = v.id;
            input.value = v.naam;
            suggestiesDiv.innerHTML = '';
            suggestiesDiv.style.display = 'none';
        };
        suggestiesDiv.appendChild(div);
      });
  } else {
      suggestiesDiv.style.display = 'none';
  }
});


// === GRAFIEK PER VV ===
document.getElementById("toonVV").addEventListener("click", async () => {
  if (!gekozenVV) return alert("Selecteer eerst een volksvertegenwoordiger.");

  const resp = await fetch(`/grafieken/vv_data/${gekozenVV}`);
  const data = await resp.json();

  const ctx = document.getElementById("vvChart").getContext("2d");
  if (vvChart) vvChart.destroy();

  vvChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [{
        label: `Vragen door ${input.value}`,
        data: data.values,
        borderColor: '#ef4444',
        backgroundColor: 'rgba(239,68,68,0.2)',
        pointBackgroundColor: '#991b1b',
        pointBorderWidth: 3,
        pointRadius: 6,
        pointHoverRadius: 8,
        tension: 0.3,
        fill: true
      }]
    },
    options: { 
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } }, 
        plugins: { legend: { display: true, position: 'bottom' } } 
    }
  });
});


// === KLIK OP PUNT IN GRAFIEK PER VV (Met jouw Fix!) ===
document.getElementById("vvChart").onclick = async (evt) => {
  if (!vvChart || !gekozenVV) return;
  const points = vvChart.getElementsAtEventForMode(evt, "nearest", { intersect: true }, true);
  if (!points.length) return;

  const point = points[0];
  const label = vvChart.data.labels[point.index];
  const [maandStr, jaarStr] = label.split(" ");
  
  const nlMaanden = {
    "jan":1, "feb":2, "mrt":3, "apr":4, "mei":5, "jun":6,
    "jul":7, "aug":8, "sep":9, "okt":10, "nov":11, "dec":12
  };

  const maand = nlMaanden[maandStr.toLowerCase()];
  const jaar = parseInt(jaarStr);

  const response = await fetch(`/grafieken/vv_vragen/${gekozenVV}/${jaar}/${maand}`);
  const data = await response.json();

  toonDetails(data, `${maandStr} ${jaar}`);
};

// --- FUNCTIE OM DETAILS TE TONEN (In Modal) ---
function toonDetails(data, label) {
    const modalTitle = document.getElementById("modalTitle");
    const modalContent = document.getElementById("modalContent");
    
    modalTitle.textContent = `Vragen in ${label}`;
    modalContent.innerHTML = "";

    if (!data.length) {
        modalContent.innerHTML = "<div class='p-3'>Geen schriftelijke vragen gevonden.</div>";
    } else {
        data.forEach(v => {
            const item = document.createElement("div");
            item.className = "list-group-item";
            
            let linkHtml = "";
            if (v.link) {
                linkHtml = `<a href="${v.link}" target="_blank" class="btn btn-sm btn-primary float-end">PDF</a>`;
            }

            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div>
                        <small class="text-muted">${v.datum}</small>
                        <h6 class="mb-1 mt-1 fw-bold" style="font-size:1rem;">${v.onderwerp}</h6>
                    </div>
                    ${linkHtml}
                </div>
            `;
            modalContent.appendChild(item);
        });
    }

    const modal = new bootstrap.Modal(document.getElementById("detailModal"));
    modal.show();
}
</script>

{% endblock %}